<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Service Exchange Protocol Documentation</title>
        <meta name="robots" content="noindex" />
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Service Exchange Protocol (SEP) documentation">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Quick-start</li><li class="chapter-item expanded "><a href="quickstart/quickstart.html"><strong aria-hidden="true">1.</strong> Quick-start</a></li><li class="chapter-item expanded affix "><li class="part-title">Service Exchange Protocol (SEP)</li><li class="chapter-item expanded "><a href="overview/overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="process/process.html"><strong aria-hidden="true">3.</strong> Process</a></li><li class="chapter-item expanded "><a href="primitives/primitives.html"><strong aria-hidden="true">4.</strong> Primitives</a></li><li class="chapter-item expanded "><a href="components/components.html"><strong aria-hidden="true">5.</strong> Components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="components/messaging.html"><strong aria-hidden="true">5.1.</strong> Messaging</a></li><li class="chapter-item expanded "><a href="components/storage.html"><strong aria-hidden="true">5.2.</strong> Storage</a></li><li class="chapter-item expanded "><a href="components/execution.html"><strong aria-hidden="true">5.3.</strong> Execution</a></li></ol></li><li class="chapter-item expanded "><a href="unresolved_issues/unresolved_issues.html"><strong aria-hidden="true">6.</strong> Unresolved_Issues</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Service Exchange Protocol Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rndlabs/sep-docs" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<p>Hello and welcome to the Service Exchange Protocol (SEP) - bringing transparency to service marketplaces.</p>
<p>SEP aims to enable developers to build blockchain secured, consumer anonymous, peer-to-peer service marketplaces for the following structures:</p>
<ol>
<li>Service delivery at a fixed address (e.g. a hotel or barber)</li>
<li>Service delivery between two or more known, fixed addresses (e.g. trains or flights)</li>
<li>Service delivery between two or more random addresses (e.g. ride-hailing or food delivery)</li>
</ol>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h2>
<ul>
<li><a href="quickstart/quickstart.html">Quick-start</a></li>
<li><a href="overview/overview.html">SEP Overview</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="quick-start"><a class="header" href="#quick-start">Quick-start</a></h1>
<p>When running the proof of concept, there are three features that need to be run simultaneously: the blockchain <a href="quickstart/quickstart.html#hardhat-node">node</a>, the <a href="quickstart/quickstart.html#server">real-world service provider</a>, and the <a href="quickstart/quickstart.html#client">consumer</a>.</p>
<h2 id="hardhat-node"><a class="header" href="#hardhat-node">Hardhat node</a></h2>
<p>Clone the <code>sep-contracts</code> repository:</p>
<pre><code class="language-bash">git clone https://github.com/rndlabs/sep-contracts
</code></pre>
<p>Install the dependencies:</p>
<pre><code class="language-bash">cd sep-contracts
yarn
</code></pre>
<p>Compile <code>typechain</code> artifacts:</p>
<pre><code class="language-bash">yarn hardhat compile
</code></pre>
<p>Generate a <code>mnemonic</code> that you can use for test accounts. To do so, you can use <a href="https://iancoleman.io/bip39/">this BIP39 generator</a>. At the Mnemonic Code Converter:</p>
<ul>
<li>Select ‘24’ words from the drop-down box.</li>
<li>Press ‘GENERATE’</li>
<li>Copy the results of the <code>BIP39 Mnemonic</code> field to clipboard for the next step.</li>
</ul>
<p>Configure the environment variables (<code>.env</code>), within the cloned repository’s root directory to be similar to:</p>
<pre><code class="language-raw title=&quot;.env&quot;"># network specific node uri : `&quot;ETH_NODE_URI_&quot; + networkName.toUpperCase()`
ETH_NODE_URI_MAINNET=https://eth-mainnet.alchemyapi.io/v2/&lt;apiKey&gt;
ETH_NODE_URI_SOKOL=https://sokol.poa.network
ETH_NODE_URI_GNOSIS=https://rpc.xdaichain.com
# generic node uri (if no specific found) :
ETH_NODE_URI=https://{{networkName}}.infura.io/v3/&lt;apiKey&gt;

# network specific mnemonic : `&quot;MNEMONIC_ &quot; + networkName.toUpperCase()`
# MNEMONIC_MAINNET=&lt;mnemonic for mainnet&gt;
# generic mnemonic (if no specific found):
MNEMONIC=&lt;paste your mnemonic here with greater than/less than symbols&gt;

# forking
# HARDHAT_FORK=gnosis

# coinmarketcap api key for gas report
COINMARKETCAP_API_KEY=
REPORT_GAS=true

# Etherscan API key for automatic verification of contracts
ETHERSCAN_API_KEY=
</code></pre>
<p>Now start the hardhat local blockchain for testing:</p>
<pre><code class="language-bash">yarn hardhat node
</code></pre>
<p>When starting the hardhat local node, search through the console output for the address at which the <code>ServiceProvider</code> contract was deployed. Example:</p>
<pre><code>deploying &quot;ServiceProvider&quot; (tx: 0x717c1eb6649abe7b92a0a2bead9b9f3b505da385980486283e5912ac90d699a9)...: deployed at 0x29b67856f9ca63dF5E688454B17F70Afd5071aa0 with 1758370 gas
</code></pre>
<p>In the above example, the <code>ServiceProvider</code> contract was deployed to <code>0x29b67856f9ca63dF5E688454B17F70Afd5071aa0</code>. Copy the address where it deployed on <strong>your</strong> local hardhat node as this will be used in subsequent configuration. For now though, your local blockchain node is running and ready to accept connections!</p>
<h2 id="server"><a class="header" href="#server">Server</a></h2>
<p>Open another terminal window and clone the <code>sep</code> repository.</p>
<blockquote>
<p>Be sure not to clone <code>sep</code> into the <code>sep-contracts</code> directory.</p>
</blockquote>
<pre><code class="language-bash">git clone https://github.com/rndlabs/sep
</code></pre>
<p>Install the dependencies:</p>
<pre><code class="language-bash">yarn                  # installs lerna for monorepo
yarn lerna bootstrap  # bootstrap packages
</code></pre>
<p>Change to the <code>demo</code> directory:</p>
<pre><code class="language-bash">cd packages/demo
</code></pre>
<p>Generate the protobuf TypeScript:</p>
<pre><code class="language-bash">yarn protoc --ts_out ./src/proto --proto_path ./src/proto ./src/proto/*
</code></pre>
<p>Copy over the <code>typechain</code> artifacts from the <code>sep-contracts</code> repo:</p>
<pre><code class="language-bash">cp -pR path/to/sep-contracts/typechain .
</code></pre>
<p>Configure the environment varibles (<code>.env</code>) in the <code>demo</code> directory to be similar to:</p>
<pre><code class="language-raw title=&quot;packages/demo/.env&quot;">MNEMONIC=&lt;paste your mnemonic from before here with greater than/less than symbols&gt;
SERVER_KEY_INDEX=1
CLIENT_KEY_INDEX=2
RPC_URL=http://127.0.0.1:8545
SEP_DAPP_NAME=sep-movi
SEP_DAPP_VERSION=1
REGISTRY_ADDRESS=&lt;fill in with deployment address from sep-contracts&gt;
SELLER_NAME=Testing Seller
SELLER_DATA_URI=http://testurl/
SELLER_LOCATION=u173z
</code></pre>
<p>Now, you can start the <code>server</code>, and this will simulate being a service provider:</p>
<pre><code class="language-bash">yarn ts-node ./src/server.ts
</code></pre>
<p>At this point, you should see the following activity:</p>
<ol>
<li>The <code>server</code> registers a test <code>seller</code>.</li>
<li>The <code>server</code> registers 5 <code>space</code>s for the <code>sellerHash</code> from (1).</li>
<li>The <code>server</code> connects to <code>Waku</code> to monitor applicable <code>content-topic</code>s.</li>
</ol>
<p>This activity will be visible on the <a href="quickstart/quickstart.html#hardhat-node">node</a> as well as on the <code>server</code>.</p>
<h2 id="client"><a class="header" href="#client">Client</a></h2>
<p>Open another terminal window and change into the <code>demo</code> package’s directory:</p>
<pre><code class="language-bash">cd path/to/demo
</code></pre>
<p>All the configuration for the <code>client</code> has already been done from the previous steps, so we can now run the <code>client</code> to make a query for a ride:</p>
<pre><code class="language-bash">yarn ts-node ./src/client.ts
</code></pre>
<p>At this point, you should see the following activity:</p>
<ol>
<li>The <code>client</code> connects to <code>Waku</code> and asks (ping) for all <code>sellerHash</code> in a certain shard.</li>
<li>The <code>server</code> responds (pong)with it’s <code>sellerHash</code> and some additional details.</li>
<li>The <code>client</code> verifies the pong from the <code>server</code> against the <code>ServiceProvider</code> contract.</li>
<li>The <code>client</code>, knowing there is a legitimate <code>seller</code>, asks for a stay with specific parameters (check-in, check-out, number of adults, number of children, number of spaces).</li>
<li>The <code>server</code> receives the query from (4) and dispatches this to an <code>auctioneer</code> that takes the <code>ask</code> parameters as input. It’s then determined if the <code>seller</code> wants to make a <code>bid</code> for this business.</li>
<li>The <code>server</code> crafts a <em>signed</em> bid to <code>client</code>.</li>
<li>The <code>client</code> verifies the <code>server</code>’s bid, and chooses one of the offers.</li>
<li>The <code>client</code> uses the bid’s <code>signature</code> to make the deal on-chain.</li>
<li>The <code>server</code>, through event monitoring, can see that the <code>client</code> has made the deal. 🥳</li>
</ol>
<blockquote>
<p>Sometimes there are connectivity issues to <code>Waku</code> from the <code>client</code>. Use <code>Ctrl + C</code> to terminate the <code>client</code> and start it again.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>This specification describes how <em>real-world</em> service providers and consumers interact using the Service Exchange Protocol to effect an exchange of a service.</p>
<p>This allows any service provider to create an <em>industry-specific</em> marketplace on which to advertise their inventory in a permissionless, decentralised manner.</p>
<h2 id="design-requirements"><a class="header" href="#design-requirements">Design requirements</a></h2>
<ul>
<li><em>Anonymity</em>: Consumers who are searching for inventory should not have any identifying information conveyed to the service provider.</li>
<li><em>Transparency</em>: All actors bearing witness to the exchange must be able to see clearly the terms by which services are exchanged.</li>
<li><em>Data ownership</em>: Service providers must be able to completely control their inventory. This control may be delegated.</li>
<li><em>Decentralised</em>: The protocol must be permissionless, relying on no centralised infrastructure.</li>
</ul>
<h2 id="rationale"><a class="header" href="#rationale">Rationale</a></h2>
<ul>
<li>Anonymity as protection against an adversarial business targetting users with aggressive pricing strategies.</li>
<li>Transparency allowing all in the marketplace to see the prices being offered and settled (akin to an L2 orderbook).</li>
<li>Data ownership to prevent vendor lock-in and subsequent rent extraction techniques.</li>
</ul>
<h2 id="terminology"><a class="header" href="#terminology">Terminology</a></h2>
<p><em>Line</em> refers to an industry that has an implementation.</p>
<p><em>Service provider</em> refers to an entity providing an <strong>intangible</strong> act for which another party is willing to pay for.</p>
<p><em>Consumer</em> refers to the party purchasing the intangible act.</p>
<p><em>Stub</em> represents a service owed by the service provider to the consumer subject to terms.</p>
<p><em>Messaging system</em> refers to the chosen protocol on which the service provider and consumer have agreed to communicate.</p>
<p><em>Personally identifiable information</em> (PII) refers to any piece of data that can be used to uniquely identify a user. For example, the signature verification key, and the hash of one’s static IP address are unique for each user and hence count as PII.</p>
<h2 id="user-stories"><a class="header" href="#user-stories">User stories</a></h2>
<ol>
<li>Search for providers by location.</li>
<li>Search for services by location matching specified parameters.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="process"><a class="header" href="#process">Process</a></h1>
<h2 id="sequence-diagram"><a class="header" href="#sequence-diagram">Sequence Diagram</a></h2>
<p><img src="process/images/process.svg" alt="SEP Sequence Diagram" /></p>
<h2 id="verification"><a class="header" href="#verification">Verification</a></h2>
<p><a href="process/./messaging">Messages</a> exchanged and <a href="process/./storage">data</a> stored are verified using an <a href="process/./on-chain">on-chain</a> registry of valid service providers. This registry provides:</p>
<ol>
<li>Role-based authentication to verify signers for the service-provider.</li>
<li>Document timestamping for data storage.</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="primitives"><a class="header" href="#primitives">Primitives</a></h1>
<h2 id="data-types"><a class="header" href="#data-types">Data types</a></h2>
<p><code>serviceProvider.id</code>: a hash of a <code>salt</code>, and <code>_msgSender()</code>.</p>
<blockquote>
<p><code>serviceProvider.id</code> is deterministic and thus requires hash collision protection.</p>
</blockquote>
<p><code>item.id</code>: a hash of <code>serviceProvider.id</code> and <code>name</code> of the item.</p>
<p><code>term.id</code>: a hash of <code>serviceProvider.id</code> and <code>name</code> of the term.</p>
<blockquote>
<p>The end-user facing explanation of what an <code>item</code> or <code>term</code> corresponds to is handled by the <code>ServiceProviderData</code> protobuf. The <code>URI</code> to find this protobuf is located in the <code>ServiceProviderRegistry</code> under the service provider. Definition of the descriptors is outside of scope for Videre, and is the job of the industry implementation.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="components"><a class="header" href="#components">Components</a></h1>
<p>Each of the SEP components rely on other protocols and systems, yet it is designed to be protocol and system agnostic. That is by design, yet in practice there aren’t many protocols and systems to pick that fulfil the design requirements, as most of them have only come into existance in the past few years. </p>
<p>The current three components and the systems used for each are:</p>
<ul>
<li><a href="components/./messaging.html">Messaging</a> is using <a href="https://waku.org">waku</a></li>
<li><a href="components/./storage.html">Storage</a> is using <a href="htpps://ethswarm.org">swarm</a></li>
<li><a href="components/./execution.html">Execution</a> is using <a href="https://gnosis.io">gnosis chain</a></li>
</ul>
<blockquote>
<p>It is important to understand that the only on-chain component is the Execution, the rest is off-chain.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div><h1 id="messaging"><a class="header" href="#messaging">Messaging</a></h1>
<p>The protocol is designed to be messaging system <em>agnostic</em>. For the quick-start and proof-of-concept implementations, the messaging system used is <a href="https://waku.org/"><em>waku</em></a>. waku fulfills the design requirement for <em>anonymous, decentralised</em> messaging. In order to meet the design <em>transparency</em> design requirements, no attempts are made to obfuscate / encrypt data. <em>Authenticity</em> is asserted using payload signatures verified against a blockchain registry. </p>
<h2 id="content-topics"><a class="header" href="#content-topics">Content Topics</a></h2>
<p>All clients communicating on the SEP do so on <em>known</em> waku <code>contentTopic</code>s. The specification for a <code>contentTopic</code> in SEP covers:</p>
<ul>
<li><code>which</code> real-world industry the service is conducted in (eg. <em>movi</em>) for accommodation.</li>
<li>A protocol <code>version</code> number to allow for graceful handling of protocol upgrades.</li>
<li><code>what</code> the specific component for the API is (eg. <code>ping</code>).</li>
<li><code>where</code> this interaction is taking place, defined by the industry implementation. For example, <code>movi</code> elects to implement this as an <a href="https://h3geo.org/"><code>h3Index</code></a>, whereas aviation may elect for this to be a bytes string such as <code>JKF-LHR</code>.</li>
<li><code>how</code> the protocol is encoded, ie. <code>proto</code> for protobuf.</li>
</ul>
<p>A complete example:</p>
<pre><code class="language-raw">/sep/movi/1/ping/8928308280fffff/proto

which   = movi
version = 1
what    = ping
where   = 8928308280fffff
how     = proto
</code></pre>
<h2 id="messages"><a class="header" href="#messages">Messages</a></h2>
<h3 id="discovery"><a class="header" href="#discovery">Discovery</a></h3>
<p><strong>Content topics <em>‘what’</em></strong>: ping, pong</p>
<pre><code class="language-protobuf">message Ping {
  // timestamp when this ping was sent.
  google.protobuf.Timestamp timestamp = 1;
}

message Pong {
  // primitive serviceProvider.id
  bytes serviceProvider = 1;
  // the location where the services are provided - specified by the industry implementation
  bytes loc = 2;
  // timestamp when the pong was sent.
  google.protobuf.Timestamp timestamp = 3;
  // signature of a bidder signer for the service provider, verifiable on-chain
  bytes signature = 4;
}
</code></pre>
<blockquote>
<p><strong>DO NOT ASSUME THAT TIMESTAMPS SENT VIA THE PROTOCOL ARE TRUSTWORTHY.</strong> </p>
</blockquote>
<h3 id="bid--ask-generic"><a class="header" href="#bid--ask-generic">Bid / Ask (Generic)</a></h3>
<p><strong>Content topics <em>‘what’</em></strong>: bid, ask</p>
<pre><code class="language-protobuf">message AskWrapper {
  // random salt used to target bid
  bytes salt = 1;
  // the payload (ask) from the consumer to the service providers
  bytes payload = 2;
}

message BidWrapper {
  // primitive serviceProvider.id
  bytes serviceProvider = 1;
  // keccak(AskWrapper.salt &amp; AskWrapper.payload) for response filtering
  bytes askDigest = 2;
  // the payload (bid) from the service provider to the consumer
  bytes payload = 3;
  // bidder signs hash of fields (1,2,3)
  bytes signature = 4;
}

message BidTerm {
  // primitive term.id - terms by which the service is subject to
  bytes term = 1;
  // the contract address implementing ITerm
  bytes impl = 2;
  // abi encoded payload that may be passed to a contract implementing ITerm
  optional bytes txPayload = 3;
}

// an optional item is an item that comes with an additional cost
message BidOptionItem {
  bytes item = 1;
  repeated videre.type.ERC20Native cost = 2;
  // bidder signs hash of fields (1, 2, askDigest)
  bytes signature = 3;
}

// an optional term is a term that comes with an additional cost
message BidOptionTerm {
  BidTerm term = 1;
  repeated videre.type.ERC20Native cost = 2;
  // bidder signs hash of fields (1, 2, askDigest)
  bytes signature = 3;
}

message BidOptions {
  // optional items and/or terms that may be purchased
  repeated BidOptionItem items = 1;
  repeated BidOptionTerm terms = 2;
}

message BidLine {
  // the item(s) offered in a bundled state, ie. space + breakfast
  repeated bytes items = 1;
  // the term(s) offered in a bundled state, ie. fully flexible + no cancellation
  repeated BidTerm terms = 2;
  // the option(s) offered, ie. add breakfast, add fully-flexible
  BidOptions options = 3;
  // the maximum number of times this bid authorisation can be used
  uint32 limit = 4;
  // the latest timestamp at which this bid is valid
  uint32 expiry = 5;
  // the cost in specified tokens or native unit of account
  // TODO: expand to detailed cost structure
  repeated videre.type.ERC20Native cost = 6; // include the capabilities for negative costs
  // bidder signs hash (AskWrapper.salt, limit, expiry, serviceProvider (which), askDigest (params), items, terms, options, cost)
  bytes signature = 7;
}

message Bids {
  // bids that match the ask
  repeated BidLine bids = 1;
}
</code></pre>
<blockquote>
<p><code>AskWrapper.payload</code> is defined as <code>bytes</code> to allow a generic, industry-agnostic bid / ask protocol to be defined. Specific ask parameters are defined in industry-specific protocol implementations of Videre.</p>
</blockquote>
<blockquote>
<p><code>BidWrapper.payload</code> is defined as <code>bytes</code> for possible future expansion to industry-specific bid replies.</p>
</blockquote>
<h3 id="movi-ride-hailing-implementation"><a class="header" href="#movi-ride-hailing-implementation">movi (Ride-hailing implementation)</a></h3>
<p>The quick-start / reference implementation for SEP is targetted at ride-hailing. Here we define the ask parameters used by <em>consumers</em>.</p>
<h4 id="sep"><a class="header" href="#sep">SEP</a></h4>
<ul>
<li>Content-topic <code>where</code> and <code>loc</code> reply: For <code>movi</code>, this is implemented as an <a href="https://h3geo.org/"><code>h3Index</code></a>.</li>
</ul>
<h4 id="messages-1"><a class="header" href="#messages-1">Messages</a></h4>
<pre><code class="language-protobuf">message moviAsk {
  // the date of check-in for the stay
  google.type.Date checkIn = 1;
  // the date of check-out for the stay
  google.type.Date checkOut = 2;
  // the number of adults staying
  uint32 numPaxAdult = 3;
  // the number of children staying
  optional uint32 numPaxChild = 4;
  // the number of spaces (rooms)
  uint32 numSpacesReq = 5;
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="storage"><a class="header" href="#storage">Storage</a></h1>
<p>The protocol is designed to be storage system agnostic. For the quick-start and proof-of-concept implementations, the data storge system used is <a href="https://ethswarm.org">swarm</a>. Swarm meets the design requirements of <em>decentralised</em> and <em>data ownership</em>. </p>
<h2 id="generic-payloads"><a class="header" href="#generic-payloads">Generic Payloads</a></h2>
<h3 id="service-provider-info--items--terms"><a class="header" href="#service-provider-info--items--terms">Service Provider Info / Items / Terms</a></h3>
<p>The initial design is for service provider data to be stored monolithically, excluding images. The payloads are generic in nature, with payloads designed to be extended by industry-specific implementations.</p>
<p>Each payload is placed in a <code>SignedPayloadWrapper</code>, with an authorised API signer having signed a hash of the payload which is subsequently placed in <code>SignedPayloadWrapper.signature</code>. This provides </p>
<pre><code class="language-protobuf">message ServiceItemData {
  // primitive item.id
  bytes item = 1;
  // industry-specific payload describing item
  bytes payload = 2;
}

message ServiceTermData {
  // primitive term.id
  bytes term = 1;
  // industry-specific payload describing term
  bytes payload = 2;
  // smart contract address that implements ITerm interface
  string implementation = 3;
}

message ServiceProviderData {
  // primitive serviceProvider.id
  bytes serviceProvider = 1;
  // services (items) provided by this service provider
  repeated ServiceItemData items = 2;
  // terms that may be applicable to services provided
  repeated ServiceTermData terms = 3;
  // industry-specific payload describing service provider
  bytes payload = 4;
  // signed hash by ServiceProvider `api` signer
  bytes signature = 5;
}
</code></pre>
<h2 id="movi-payloads"><a class="header" href="#movi-payloads">movi Payloads</a></h2>
<h3 id="driver-profile"><a class="header" href="#driver-profile">Driver Profile</a></h3>
<pre><code class="language-protobuf">// ServiceProviderData.payload
message Driver {
  // name of driver
  // vehicle description
  // phone number
  // profile picture
  // connectivity in vehicle
}
</code></pre>
<h3 id="rider-profile"><a class="header" href="#rider-profile">Rider Profile</a></h3>
<pre><code class="language-protobuf">// BuyerData.payload
message Rider {
  // name of rider
  // phone number
  // profile picture
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="execution"><a class="header" href="#execution">Execution</a></h1>
<h2 id="registries"><a class="header" href="#registries">Registries</a></h2>
<p>There is a need for a <em>source of truth</em> as to what can be trusted in SEP. The registries broadly cover the areas of:</p>
<ul>
<li><a href="components/execution.html#industries">Industries</a></li>
<li><a href="components/execution.html#document-timestamps">Document Timestamps</a></li>
<li><a href="components/execution.html#service-providers">Service Providers</a></li>
</ul>
<blockquote>
<p>For initial development phase of SEP, addresses will require whitelisting so that they may register a service provider with smart-contract enforced sunset clause for the whitelisting of <strong>180 days</strong> (ie. after which <em>anyone</em> may register). </p>
</blockquote>
<blockquote>
<p>Reputation based scoring / assessment is <strong>OUTSIDE OF SCOPE</strong> for the initial development phase of SEP. During this phase, the SEP will <strong>NOT</strong> support terms that allow for the transfer of funds to service providers without intervention / consent of the consumer. Reputation base scoring / dispute settlement is targetted to be implemented after the cessation of the whitelist timeframe.</p>
</blockquote>
<h3 id="lines-industries"><a class="header" href="#lines-industries">Lines (Industries)</a></h3>
<p>This registry provides a canonical source for line-specific state transition contracts that allow for the issuance of <code>stubs</code>, and subsequent state changes.</p>
<p>The registry shall contain a bytes32 to address mapping for the industry-specific code (eg. “movi”) to the implementing contract. The registry shall also contain a mapping of industry to service provider to uint256. This is to be interpreted as a <code>can</code>, essentially indcating that the service provider providers a service in the specific industry, and the industry-specific terms they agree to are governed by the implementation.</p>
<p>Protocol fees for the specific industry are stored within this contract.</p>
<blockquote>
<p>It is a requirement that the service provider has agreed to the industry-specific terms / life-cycle. If they cease to agree, and exit the industry, no <strong>NEW</strong> stub issuance may take place, but old stubs and their terms remain effective.</p>
</blockquote>
<p>The above method opens up the possibility to have sub-industry, or locale specific industry implementations, such as <code>movi-JP</code> for accommodation providers in Japan.</p>
<h3 id="service-providers"><a class="header" href="#service-providers">Service Providers</a></h3>
<p>The service provider registry allows consumers to:</p>
<ol>
<li>Find where to get industry-specific information about the service provider.</li>
<li>Determine who is authorised to act in what role on behalf of the service provider.</li>
<li>Determine when an authorised party was authorised, and if their authorisation is revoked, when it was revoked.</li>
</ol>
<h3 id="document-timestamps"><a class="header" href="#document-timestamps">Document Timestamps</a></h3>
<p>Service providers store their information offline, saving on costly gas and allowing the system to remain storage system agnostic. In doing so, there is a need to determine the time at which a specific document was published.</p>
<p>The document timestamp registry allows actors on the protocol to:</p>
<ol>
<li>Determine the time at which a document was created.</li>
</ol>
<blockquote>
<p>Proof of ownership of the document is outside the scope of the timestamp registry.</p>
</blockquote>
<h2 id="accounting"><a class="header" href="#accounting">Accounting</a></h2>
<p>Accounting of funds is handled by a centralised accounting contract, similar to the <code>vat</code> system as used in MakerDAO. The actual funds are held by <em>joiner</em> contracts. This allows for the system to limit the types of collateral / tokens that may be used to pay for stubs. There are three types of accounts that may own collateral managed within the <code>vat</code>:</p>
<ol>
<li>Service Providers (<code>bytes32</code>)</li>
<li>Stubs (<code>bytes32</code>)</li>
<li>Ethereum addresses (<code>address</code>)</li>
</ol>
<p>Funds are specified in mappings such that:</p>
<ol>
<li>For <code>bytes32</code> accounts: <code>mapping (bytes32 =&gt; mapping (address =&gt; uint256))</code></li>
<li>For <code>address</code> accounts: <code>mapping (address =&gt; mapping (address =&gt; uint256))</code></li>
</ol>
<p>The zero address <code>token</code> MAY be implemented and represent the deployment chain’s native unit of account.</p>
<blockquote>
<p>As stubs may be resold on secondary markets, any collateral attached to them should move simultaneously, therefore the stub represents an account itself.</p>
</blockquote>
<p>Ownership of stubs is handled through a <code>stub</code> to <code>address</code> mapping:</p>
<ul>
<li><code>mapping (bytes32 =&gt; address)</code></li>
</ul>
<p>Similar to MakerDAO’s <code>vat</code>, root administrative contracts can be attached to the <code>vat</code> to allow custom movement of funds / stub ownership. This allows for future use cases such as a ProxyContract that implements zk ownership of a stub.</p>
<p>Industrial lines (such as <code>stays</code>) will have an account within the <code>vat</code>. This account will be an <em>ethereum address</em> corresponding to the contract’s deployment address. This allows for the system to accrue protocol fees, and to account for these fees on a <em>per industry basis</em>, allowing the case of different protocol fees depending on an industry.</p>
<h2 id="stubs"><a class="header" href="#stubs">Stubs</a></h2>
<p>When a service provider and consumer come to an agreement, they make a <code>deal</code>. The result of this <code>deal</code> is a <em>stub</em> (voucher) that represents a future service to be delivered by the service provider to the consumer. This future service (<em>items</em>) is subject to <em>terms</em> and carries a specified <em>cost</em>. It is the role of the line (industry) contract to implement rules defining the <em>lifecycle</em> of their issued stubs.</p>
<h3 id="items"><a class="header" href="#items">Items</a></h3>
<p>An <code>item</code> array, in the <a href="components/primitives/primitives.html">primitive</a> sense.</p>
<h3 id="terms"><a class="header" href="#terms">Terms</a></h3>
<p>A <code>term</code> is a business logic primitive for Videre, and may be called by either party, depending on the <code>term</code>. For example there may be a <code>NO_REFUND_AFTER_CHECKIN</code> term where upon the <code>consumer</code> checks into the accommodation facility, the <code>service provider</code> may call the term to have the whole balance of funds transferred to themselves.</p>
<p>Another example may be a <code>48HR_RAINCHECK</code> by which the stub may be fully refundable. The <code>consumer</code> could then call the <code>term</code> which would refund their payment provided the conditions were met.</p>
<blockquote>
<p>Careful consideration should be given to terms and the privacy implications that they may have.</p>
</blockquote>
<h2 id="utility"><a class="header" href="#utility">Utility</a></h2>
<p>These are contracts that help with usability / specific cases.</p>
<h3 id="nft-wrapper"><a class="header" href="#nft-wrapper">NFT Wrapper</a></h3>
<p>A <code>stub</code> holder can transfer their <code>stub</code> to the NFTWrapper which then subsequently becomes the owner of the <code>stub</code> in the <code>vat</code>, though the respective NFT <code>tokenId</code> that is issued is minted to the stub holder.</p>
<p>The wrapper would contain a <code>tokenId</code> to <code>stub</code> mapping, and <code>tokenId</code> to <code>owner</code> mapping. This wrapper should also proxy the <code>ILifeCycle</code> interface so that calls can just be forwarded directly from the token owner to the industry-specific life-cycle implementation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="unresolved_issues"><a class="header" href="#unresolved_issues">Unresolved_Issues</a></h1>
<ol>
<li>Prevent a driver from renouncing a bidder / API key to void offers / existing confirmations
Allow setting of global response options (ie. not just per bidline options)</li>
<li>Implement timestamp for granting of granting and revocation of roles. use</li>
</ol>
<p>struct Timestamps {
uint128 granted;
uint128 revoked;
}</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
        <script type="text/javascript">
        window.addEventListener('load', function() {
            MathJax.Hub.Register.StartupHook('End', function() {
                window.setTimeout(window.print, 100);
            });
        });
        </script>
    </body>
</html>
